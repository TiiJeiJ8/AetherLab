# Fuck-Charts 多文件数据整合与图表配置说明

## 目录
- [背景与目标](#背景与目标)
- [核心数据结构](#核心数据结构)
- [数据流与自动对象数组生成](#数据流与自动对象数组生成)
- [多文件字段映射与合并逻辑](#多文件字段映射与合并逻辑)
- [主键与行号对齐策略](#主键与行号对齐策略)
- [健壮性与异常处理](#健壮性与异常处理)
- [常见问题与建议](#常见问题与建议)

---

## 背景与目标

本项目旨在实现一个支持多文件、多字段映射、过滤和高级配置的可拖拽图表配置面板，要求：
- 前端模块化、可维护、可扩展
- 支持多种图表类型，数据驱动渲染
- 能正确处理多文件来源、同名字段、数据合并等复杂场景
- 支持全局数据结构优化，多文件数据整合与调试

---

## 核心数据结构

### workspaceFiles
- 类型：`Array<Object>`
- 结构示例：
  ```js
  [
    {
      name: 'Region heatmap map test data.xlsx',
      headers: ['Province', 'Value', 'City'],
      data: [
        ['广东', 15, '广州'],
        ['浙江', 4, '南京'],
        // ...
      ],
      // 其它元数据
    },
    // ...
  ]
  ```

### fileDataMap
- 类型：`Computed<Object>`
- 作用：自动将每个文件的 headers + data 组装成对象数组，便于字段查找和合并。
- 生成逻辑：
  ```js
  const fileDataMap = computed(() => {
    const map = {}
    workspaceFiles.value.forEach(file => {
      if (file.data && file.headers) {
        const rows = file.data
        if (Array.isArray(rows) && Array.isArray(file.headers)) {
          map[file.name] = rows.map(row =>
            Object.fromEntries(file.headers.map((h, i) => [h, row[i]]))
          )
        }
      }
    })
    return map
  })
  ```

---

## 数据流与自动对象数组生成

1. 用户上传/导入文件，workspaceFiles 自动更新。
2. fileDataMap 响应式地将每个文件的 headers+data 组装成对象数组（无需 parsedData 字段）。
3. 拖拽字段到映射区，仅配置 chartConfig，不影响 fileDataMap。
4. 生成图表时，根据 chartConfig 里的 file 字段，从 fileDataMap 取出对应数据。

---

## 多文件字段映射与合并逻辑

- chartConfig 记录每个映射字段的 file、field、index 等信息。
- 生成图表时，按 chartConfig 里的文件名，从 fileDataMap 取出数据对象数组。
- 支持多文件、多字段、多 y 轴等复杂场景。

---

## 主键与行号对齐策略

### 有主键时（推荐）
- 以 x 轴文件为主，遍历每一行，按主键（如 Province）在其它文件查找对应行，找不到补 null。
- 本质是“左连接”。
- 示例：
  | Province | Value | GDP  |
  | -------- | ----- | ---- |
  | 广东     | 15    | 1000 |
  | 浙江     | 4     | 800  |
  | 山西     | 75    | null |

### 无主键时
- 按行号对齐，y 轴数据比 x 轴长则截断，比 x 轴短则补 null。
- 保证 x/y 数据长度一致，避免错位和报错。
- 示例：
  - xData: 5 行，yData: 7 行 → yData 只取前 5 行
  - xData: 5 行，yData: 3 行 → yData 补 2 个 null

---

## 健壮性与异常处理

- fileDataMap 始终以 workspaceFiles 为源，自动生成对象数组。
- 生成图表时，始终以 x 轴为基准长度，保证数据一致性。
- 缺失数据自动补 null，避免渲染报错。
- UI 可提示用户“未设置主键时，数据将按行号对齐，多余部分会被截断”。

---

## 常见问题与建议

- **Q: fileDataMap 为什么为空？**
  - A: 只认 parsedData 字段时会为空，需用 headers+data 自动组装对象数组。
- **Q: 拖拽和 fileDataMap 有什么关系？**
  - A: 拖拽只影响 chartConfig，fileDataMap 始终反映所有文件的完整数据。
- **Q: 多文件字段长度不一致怎么办？**
  - A: 以 x 轴为基准，y 轴多余截断，少了补 null。
- **Q: 没有主键能合并吗？**
  - A: 可以，但只能按行号对齐，建议设置主键获得更准确的数据合并。

---

如需进一步扩展或定制数据整合逻辑，请参考本说明文档并结合实际业务需求进行调整。
